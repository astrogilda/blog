---
title: "Mutation Testing as a Safety Gate for Largeâ€‘Scale Refactors"
description: "Why code coverage is insufficient and how to use mutmut mutation testing as a hard CI gate for your Python refactors."
slug: "mutation-testing-mutmut-refactoring-safety"
date: 2025-06-20
tags: ["python", "testing", "mutation-testing", "mutmut", "ci"]
---

## 1 Â· Coverage isnâ€™t safety

A passing test suite with **100â€¯% coverage** only proves the lines executedâ€”**not** that logic is correct.  
If assertions are weak, critical bugs slip through.

```python
def is_positive(n):
    return n > 0

def test_is_positive():
    is_positive(5)   # 100â€¯% coverage, zero assertions!
```

Change to `n >= 0`â€”tests still â€œpassâ€.

---

## 2 Â· Mutation testing: tests that test tests

1. **Generate mutants** â€“ each with one tiny change (`>` â†’ `>=`, `+` â†’ `-`, etc.).  
2. **Run tests** against each mutant.  
3. **Score**: `killed / total_non_equivalent`.  
   * Survived mutant ğŸ™ = hole in your test suite.

---

## 3 Â· Configure `mutmut`

`pyproject.toml`

```toml
[tool.mutmut]
paths_to_mutate     = "rtanalysis/"
tests_dir           = "tests/"
runner              = "pytest -x"
use_coverage        = true
paths_to_exclude    = "rtanalysis/__init__.py,rtanalysis/logging_config.py"
```

* `use_coverage=true` skips lines never executed â†’ huge speed gain.  
* `-x` stops on first failure â†’ faster mutant kill loop.

---

## 4 Â· Testing structured logs with `pytest-structlog`

```python
# tests/test_logging.py
import pytest_structlog
from rtanalysis.rtanalysis import RTAnalysis

def test_fit_logs_context(log: pytest_structlog.StructuredLogCapture):
    rta = RTAnalysis()
    # ... prepare data ...
    rta.fit(rt_series, acc_series)

    log.assert_event_logged(
        "model_fitting_complete",
        mean_rt=2.0,
        mean_acc=0.8,
    )
```

A mutant flipping `mean_acc` to `0.9` will be **killed**.

---

## 5 Â· GitHubâ€¯Actions safety gate

`.github/workflows/mutation.yml`

```yaml
name: Mutation Testing Gate
on:
  pull_request:
    paths:
      - "rtanalysis/**"
      - "tests/**"

jobs:
  mutation-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with: { python-version: "3.11" }

      - name: Install deps
        run: |
          pip install -r requirements.txt
          pip install mutmut pytest-cov pytest-structlog

      - name: Run mutmut
        run: mutmut run --ci

      - name: Fail if score < 100Â %
        run: mutmut junitxml --fail-under 100

      - name: HTML report
        run: mutmut html

      - uses: actions/upload-artifact@v4
        with:
          name: mutation-report
          path: html/
```

*Branch protection* â†’ require job success â†’ no PR merges unless MSI â‰¥ target.

---

## 6 Â· Wrapâ€‘up

Mutation testing converts **speculative confidence** into **measurable safety**; coupled with structured logging refactor, it guarantees behaviour stays intact.

Next post: **AI assistant showdown**â€”Copilot vsâ€¯Cody vsâ€¯OpenRouter vsâ€¯local Llama.

---

> **Grab the readyâ€‘made** â†’ [Download mutation.yml](https://your-link/mutation.yml)  
> **Need help wiring mutation gates?** Book a 20-min consult â†’ [https://calendly.com/your-link](https://calendly.com/your-link)
